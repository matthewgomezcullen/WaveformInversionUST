# k-Wave Simulations

In our past works, we included [k-Wave](http://www.k-wave.org/) simulated datasets. This time, rather than provide the datasets themselves, we provide the code to run the k-Wave simulations that generate those datasets. We do this to conserve space and provide codes to simulate UST using [k-Wave](http://www.k-wave.org/). Each [k-Wave](http://www.k-wave.org/) simulation involves a 3-step process:

1) [GenKWaveSimInfo.m](https://github.com/rehmanali1994/WaveformInversionUST/blob/main/Simulations/GenKWaveSimInfo.m) creates a MAT file that is stored in the [Simulations/sim_info](https://github.com/rehmanali1994/WaveformInversionUST/tree/main/Simulations/sim_info) folder. This MAT file contains all the information (medium, ring array geometry, and pulse excitation) needed to simulate the UST system. [GenKWaveSimInfo.m](https://github.com/rehmanali1994/WaveformInversionUST/blob/main/Simulations/GenKWaveSimInfo.m) uses [sampled_circle.m](https://github.com/rehmanali1994/WaveformInversionUST/blob/main/Simulations/phantoms/sampled_circle.m) to create the ring-array transducer and [soundSpeedPhantom2D.m](https://github.com/rehmanali1994/WaveformInversionUST/blob/main/Simulations/phantoms/soundSpeedPhantom2D.m) to produce the material properties used in each simulation. Two breast imaging cases are simulated: `option = 1` is from a breast CT; `option = 2` is from a breast MRI.
2) After generating the MAT file in [Simulations/sim_info](https://github.com/rehmanali1994/WaveformInversionUST/tree/main/Simulations/sim_info), we run the actual [k-Wave](http://www.k-wave.org/) simulation using [GenRFDataSingleTxKWave.m](https://github.com/rehmanali1994/WaveformInversionUST/blob/main/Simulations/GenRFDataSingleTxKWave.m). The `option` parameter corresponding to the simulation case must be specified. [GenRFDataSingleTxKWave.m](https://github.com/rehmanali1994/WaveformInversionUST/blob/main/Simulations/GenRFDataSingleTxKWave.m) loops through each single-element transmit. The simulated data for each transmit is then stored in MAT files the [Simulations/scratch](https://github.com/rehmanali1994/WaveformInversionUST/tree/main/Simulations/scratch) folder.
3) Lastly, [AssembleUSCTChannelData.m](https://github.com/rehmanali1994/WaveformInversionUST/blob/main/Simulations/AssembleUSCTChannelData.m) assembles the simulated data from each indivdual transmit/MAT-file in the [Simulations/scratch](https://github.com/rehmanali1994/WaveformInversionUST/tree/main/Simulations/scratch) folder into a single MAT file containing the full UST dataset in the [Simulations/datasets](https://github.com/rehmanali1994/WaveformInversionUST/tree/main/Simulations/datasets) folder: kWave_BreastCT.mat (`option = 1`); kWave_BreastMRI.mat (`option = 2`).

## UIUC Datasets

**Please download the datasets ("uiuc" folder) under the [releases](https://github.com/matthewgomezcullen/WaveformInversionUST/releases) tab for this repository, and place the datasets folder in the [phantoms](https://github.com/matthewgomezcullen/WaveformInversionUST/tree/main/Simulations/phantoms) folder.**

Please set `option = 3` and `id = <7, 35, or 47>` in [GenKWaveSimInfo.m](https://github.com/matthewgomezcullen/WaveformInversionUST/blob/main/Simulations/GenKWaveSimInfo.m) and [GenRFDataSingleTxKWave.m](https://github.com/matthewgomezcullen/WaveformInversionUST/blob/main/Simulations/GenRFDataSingleTxKWave.m).

With `option = 3`, [GenKWaveSimInfo.m](https://github.com/matthewgomezcullen/WaveformInversionUST/blob/main/Simulations/GenKWaveSimInfo.m) will use [soundSpeedPhantomUIUC.m](https://github.com/rehmanali1994/WaveformInversionUST/blob/main/Simulations/phantoms/soundSpeedPhantomUIUC.m) instead of [soundSpeedPhantom2D.m](https://github.com/rehmanali1994/WaveformInversionUST/blob/main/Simulations/phantoms/soundSpeedPhantom2D.m) to convert the UIUC dataset of interest (expressed via the `id`) to a sound speed map.

**Note**, the UIUC datasets are 3D mappings outlining the tissue types of voxels in a medium representing a breast. The provided code takes a 2D slice of the medium, taken at an x co-ordinate which is set via `X` in [GenKWaveSimInfo.m](https://github.com/matthewgomezcullen/WaveformInversionUST/blob/main/Simulations/GenKWaveSimInfo.m). Please use the [visualise.ipynb](https://github.com/matthewgomezcullen/WaveformInversionUST/tree/main/visualise.ipynb) code provided to produce 2D images of the breasts at varying values of `X`.
